# GPU 加速实时射线追踪 —— 解决 ECRH 系统中"目标位置→Launcher 角度"的计算瓶颈

---

**编制日期**: 2026年2月13日  
**文档版本**: V1.1（修正系统边界）  
**关联文件**: BEST 10MW ECRH 控制保护系统总体设计方案 V2.1 / AMD 智能化升级方案 V1.0

---

> **系统边界声明**
>
> NTM（新经典撕裂模）是托克马克等离子体的固有物理不稳定性，其检测、定位和抑制策略决策属于 **PCS（等离子体控制系统）和诊断系统** 的职责范围。ECRH 系统在 NTM 抑制中的角色是 **执行器**：接收 PCS 给出的目标沉积位置 ρ_target，将其翻译为 Launcher 角度 (θ, φ) 并精确执行。
>
> **本文聚焦的计算问题**：ECRH 系统内部的射线追踪计算——即"给定 ρ_target，如何快速准确地求解最优 Launcher 角度"。文档中关于 NTM 物理和控制全链条的内容仅作为 **背景知识**，帮助理解 ECRH 射线追踪计算为什么重要，不代表这些功能由 ECRH 系统承担。

---

## 目录

1. [背景：NTM 问题与 ECCD 抑制原理](#1-背景ntm-问题与-eccd-抑制原理)
2. [ECRH 系统的核心计算任务：射线追踪](#2-ecrh-系统的核心计算任务射线追踪)
3. [业界现状：射线追踪的实时化进展](#3-业界现状射线追踪的实时化进展)
4. [ECRH 系统内的计算瓶颈分析](#4-ecrh-系统内的计算瓶颈分析)
5. [GPU 加速射线追踪：为什么是天然匹配](#5-gpu-加速射线追踪为什么是天然匹配)
6. [AMD GPU 实施方案详细设计](#6-amd-gpu-实施方案详细设计)
7. [预期性能与对比](#7-预期性能与对比)
8. [总结与展望](#8-总结与展望)

---

## 1. 背景：NTM 问题与 ECCD 抑制原理

> **本章为物理背景介绍**，用于解释 ECRH 射线追踪计算的应用场景。NTM 的检测、定位和抑制策略决策均由 PCS 和诊断系统负责，不属于 ECRH 系统的供货范围。

### 1.1 什么是 NTM

新经典撕裂模（Neoclassical Tearing Mode, NTM）是托克马克中一种 **抗磁压力驱动的磁流体力学（MHD）不稳定性**，会在有理磁面（q = m/n 为有理数的位置）上形成 **磁岛结构**。

```
    NTM 磁岛的物理图像（极向截面）
    ═══════════════════════════════════
    
    正常磁面（嵌套的闭合磁面）:         磁岛形成后:
    
      ┌───────────────────┐             ┌───────────────────┐
      │  ╭───────────╮    │             │  ╭───────────╮    │
      │  │ ╭───────╮ │    │             │  │ ╭──╮ ╭──╮ │    │
      │  │ │ ╭───╮ │ │    │             │  │ │  ╰─╯  │ │    │
      │  │ │ │ ● │ │ │    │    →→→      │  │ │ W ● W │ │    │
      │  │ │ ╰───╯ │ │    │             │  │ │  ╭─╮  │ │    │
      │  │ ╰───────╯ │    │             │  │ ╰──╯ ╰──╯ │    │
      │  ╰───────────╯    │             │  ╰───────────╯    │
      └───────────────────┘             └───────────────────┘
      
      ● = 磁轴                          W = 磁岛 (island)
      磁面完好，约束良好                  磁面撕裂，约束退化
                                         热和粒子沿磁岛短路
```

### 1.2 NTM 的危害

| 危害 | 机制 | 严重程度 |
|------|------|---------|
| **约束退化** | 磁岛破坏磁面嵌套结构，热和粒子沿磁岛"短路"泄漏 | 能量约束时间下降 20-30% |
| **β 限制** | NTM 限制了可达到的等离子体压力（βN 上限） | 直接限制聚变反应堆性能 |
| **锁模→破裂** | 大的 2/1 磁岛减速锁定到壁上，触发大破裂 | **最严重后果：等离子体破裂** |

### 1.3 为什么 NTM 是 BEST 的核心关注点

BEST 作为全超导托克马克，目标运行于高 β 高约束模式。在这种条件下：
- 3/2 NTM 在 βN ≈ 1.5-2.0 时就会被触发
- 2/1 NTM 在 βN ≈ 2.0-2.5 时出现，若不抑制则大概率导致破裂
- **ITER 研究表明：NTM 抑制是 ECCD 系统的最高优先级应用**

---

### 1.4 ECCD 抑制 NTM 的物理原理（背景）

> **本节为物理背景**，解释为何 ECRH 射线追踪需要极高的精度。ECCD 抑制策略由 PCS 决定，ECRH 系统负责精确执行 PCS 给定的沉积目标。

#### 1.4.1 抑制机制

NTM 的驱动力是自举电流（bootstrap current）在磁岛区域的缺失。抑制策略是在磁岛位置 **精确注入 ECCD 驱动的电流**，补偿缺失的自举电流，使磁岛收缩直至消失。

```
    ECCD 抑制 NTM 的原理
    ═══════════════════════════════════════════════════

    修正的 Rutherford 方程（描述磁岛宽度 w 的演化）:
    
    dw       ┌                                          ┐
    ── ∝ Δ' │ + a_bs × (bootstrap 项, 驱动磁岛增长)     │
    dt       │ - a_cd × (ECCD 项, 抑制磁岛)             │
             │ - a_pol × (极化电流项, 小磁岛时稳定)      │
             └                                          ┘
    
    ★ ECCD 项的大小取决于:
      1. ECCD 驱动电流密度 j_cd
      2. ECCD 沉积位置 ρ_dep 与磁岛位置 ρ_island 的对准精度
      3. ECCD 沉积宽度 Δρ_cd 与磁岛宽度 w 的匹配关系
    
    ★ 关键要求:
      |ρ_dep - ρ_island| < w/2 （沉积位置必须落在磁岛内部）
      对于典型 NTM: w ~ 5-10 cm → 精度要求 < 2-3 cm
```

#### 1.4.2 精确沉积的关键性 —— 对 ECRH 射线追踪精度的物理要求

**NTM 抑制效率对 ECCD 沉积位置精度极其敏感**：

```
    ECCD 沉积位置偏差与抑制效率的关系（示意）
    ──────────────────────────────────────────
    
    抑制效率 η
    100% │         ████
         │       ██    ██
     80% │     ██        ██
         │    █            █
     60% │   █              █
         │  █                █
     40% │ █                  █
         │█                    █
     20% │                      █
         │                       █
      0% ├──┬──┬──┬──┬──┬──┬──┬──┬──→ Δρ (沉积偏差)
         0  1  2  3  4  5  6  7  8  cm
         
         ↑ 偏差 < 2 cm: 效率 > 80%
              偏差 > 5 cm: 几乎无效
    
    ★ 这就是为什么射线追踪的精度和实时性如此关键
    ★ ITER 要求: 2/1 NTM 沉积精度 < 5 mm, 3/2 NTM < 7 mm
```

### 1.5 NTM 抑制控制链与 ECRH 系统的角色

```
    NTM 抑制完整控制链 —— 系统边界标注
    ═══════════════════════════════════════════════════════════════════
    
    ① 检测        ② 定位           ③ 计算          ④ 执行
    ──────        ──────           ──────          ──────
    
    Mirnov →  ┌ EFIT 实时平衡重建 ┐  ┌ 射线追踪 ┐   ┌ Launcher ┐
    线圈    → │ 确定磁岛位于      │→ │ ρ_target  │→  │ 调整     │
    ECE     → │ 哪个磁面          │  │ → (θ,φ)  │   │ 镜面角度 │
    诊断    → │ (ρ_island)        │  │ 最优角度  │   │          │
              └───────────────────┘  │ 求解      │   │ 回旋管   │
                                     │           │   │ 功率调节 │
              需要: ~5-10 ms         │           │   │          │
                                     └───────────┘   └──────────┘
                                     需要: ★瓶颈★     需要: ~1 ms
                                     当前: 15-20 ms
    
    ├─ PCS + 诊断系统 负责 ──────┤├─ ECRH 系统负责 ──────────────┤
       (不属于 ECRH 供货范围)          (ECRH 核心计算任务)
    
    ═══════════════════════════════════════════════════════════════════
    
    ★ ECRH 系统接收 PCS 输出的目标沉积位置 ρ_target
    ★ ECRH 内部通过射线追踪将 ρ_target 翻译为 Launcher 角度 (θ,φ)
    ★ 射线追踪是 ECRH 系统内部计算量最大、延迟最高的环节
    ★ 本文聚焦于加速这一 ECRH 内部的计算环节
```

---

## 2. ECRH 系统的核心计算任务：射线追踪

> **从本章起进入 ECRH 系统范围内的技术分析**。射线追踪是 ECRH 系统内部将 PCS 给定的 ρ_target 翻译为 Launcher 角度 (θ, φ) 的核心计算手段。

### 2.1 ECRH 系统为什么需要射线追踪

ECRH 系统面临的核心计算问题可以表述为：

```
    ECRH 系统的核心计算任务
    ═══════════════════════════════════════════════════════════

    输入（来自 PCS，ECRH 不负责产生）:
    • ρ_target —— 目标沉积位置（磁面归一化坐标）
    • ne(R,Z), Te(R,Z), B(R,Z) —— 等离子体剖面参数

    需要求解:
    • 最优 Launcher 角度 (θ_opt, φ_opt)
    • 使得射线在等离子体中传播后，沉积位置 ρ_dep 满足:
      |ρ_dep(θ,φ) - ρ_target| < 精度要求（典型 Δρ < 0.05）
    • 同时最大化 ECCD 驱动效率 η_cd

    为什么不能用简单映射:
    • 微波在等离子体中是弯曲传播的（折射）
    • 传播路径依赖于等离子体密度、温度和磁场分布
    • 这些参数在放电过程中持续变化
    • 因此 (θ,φ) → ρ_dep 的映射是动态的，必须实时计算

    ═══════════════════════════════════════════════════════════
```

### 2.2 什么是等离子体射线追踪

等离子体中的微波（电子回旋波）不像在真空中沿直线传播。由于等离子体是 **色散、非均匀、各向异性的介质**，微波束会发生折射、吸收和模式转换。射线追踪（Ray Tracing）是计算微波束在等离子体中传播路径和功率沉积位置的 **标准数值方法**。

### 2.3 数学模型

射线追踪求解 **Hamilton 射线方程组**（一组常微分方程 ODE）：

```
    Hamilton 射线方程组
    ═══════════════════════════════════════════════
    
    dr         ∂H/∂k
    ── = - ──────────      （射线位置的演化）
    dτ       ∂H/∂ω
    
    dk        ∂H/∂r
    ── = + ──────────      （射线波矢的演化）
    dτ       ∂H/∂ω
    
    其中:
    H(r, k, ω) = 0  是色散关系
    r = (R, Z, φ) 是位置坐标
    k = (kR, kZ, kφ) 是波矢
    ω = 2π × 140 GHz 是微波频率
    
    色散关系 H 依赖于:
    • 电子密度 ne(R, Z) — 来自密度剖面诊断
    • 电子温度 Te(R, Z) — 来自温度剖面诊断
    • 磁场 B(R, Z) — 来自 EFIT 平衡重建
    
    ═══════════════════════════════════════════════
    
    求解过程:
    • 从 Launcher 位置出发，给定初始方向(θ_pol, θ_tor)
    • 沿射线路径逐步积分 ODE
    • 每一步计算局部吸收系数 α(r)
    • 积分吸收得到功率沉积剖面 P_dep(ρ)
    
    典型计算量:
    • 每条射线: ~10⁴ ODE 积分步
    • 每步: 评估色散关系 + 吸收系数 ≈ 数百次浮点运算
    • 单条射线总计: ~10⁶ 次浮点运算
    • 高斯束: 需追踪 ~10-50 条射线来表征束宽
```

### 2.4 主流射线追踪代码

| 代码 | 开发机构 | 方法 | 特点 | 实时能力 |
|------|---------|------|------|---------|
| **TORBEAM** | IPP Garching (德国) | 束追踪 (Beam Tracing) | 考虑衍射效应；追踪束轴 + 束宽 + 波前曲率 | ★ 已实现实时版本 (rt-TORBEAM)，15-20 ms / 12束 |
| **GRAY** | IFP-CNR (意大利) | 射线/束追踪 | 支持多种模式；用于 DTT 等装置设计 | 有简化版本可做近实时 |
| **GENRAY** | CompX (美国) | 通用射线追踪 | 功能全面，支持多种波模式 | 主要用于离线分析 |
| **TRAVIS** | IPP Greifswald (德国) | 射线追踪 | W7-X 专用；弱相对论轨迹 + 全相对论吸收 | 离线使用 |
| **C3PO/LUKE** | CEA (法国) | 射线追踪 + Fokker-Planck | 含动理学效应 | 离线使用 |

---

## 3. 业界现状：射线追踪的实时化进展

> **本章综述各装置如何解决实时射线追踪计算问题**。各装置的 NTM 控制架构整体呈现，但 ECRH 系统关注的焦点在 **射线追踪计算环节**的方法和性能，而非上游的 NTM 检测/定位。

### 3.1 ASDEX Upgrade（德国 IPP Garching）—— 最成熟的实时射线追踪

**实现方案**：将 TORBEAM 代码优化为实时版本 rt-TORBEAM，作为 ECRH Launcher 角度计算模块运行。

```
    ASDEX Upgrade 射线追踪实时化方案
    ═══════════════════════════════════════════════════════════

    PCS 输出         ECRH 内部计算             ECRH 执行
    (非 ECRH 范围)    (射线追踪)                (角度控制)
    ┌──────────────┐  ┌──────────────────┐    ┌──────────────┐
    │ ρ_target     │─→│ rt-TORBEAM       │──→ │ Launcher     │
    │ ne, Te, B    │  │ (实时束追踪)      │    │ 镜面角度调节  │
    │ (来自 PCS +  │  │                  │    │              │
    │  诊断系统)    │  │ 12束并行追踪     │    └──────────────┘
    └──────────────┘  │ 周期: 15-20 ms   │
                      └──────────────────┘

    射线追踪关键技术:
    • 首次将 TORBEAM 加速 ~100 倍用于实时运行
    • 通过多线程并行化 12 束的独立计算（每线程 1 束）
    • 使用简化的束追踪方程（保留衍射效应）

    射线追踪的局限（ECRH 视角）:
    • 15-20 ms 周期 —— 只能做正向计算（给定角度→算沉积位置）
    • 无法实时搜索"最优角度"—— 遍历候选角度的计算量超出 CPU 能力
    • CPU 单核性能是单束计算速度的瓶颈
    ═══════════════════════════════════════════════════════════
```

### 3.2 DIII-D（美国 GA）—— 射线追踪与 ML 剖面重建结合

**实现方案**：rt-TORBEAM + 机器学习辅助剖面重建。

```
    DIII-D 射线追踪技术进展（ECRH 相关部分）
    ═══════════════════════════════════════════════════════════

    与 ECRH 射线追踪直接相关的技术:

    1. rt-TORBEAM 执行时间 < 20 ms
       → 通过自研的实时安全多线程库实现确定性延迟
       → 6 面镜面独立计算
    
    2. RTCAKENN: 基于机器学习的实时动理学剖面重建
       → 执行时间 < 8 ms
       → 为射线追踪提供更准确的 ne/Te 输入
       → 这是 ECRH 射线追踪的数据前处理环节
    
    3. 多种 Launcher 对准方法（ECRH 系统执行层面）:
       ├── 阶梯对准 (step alignment): 逐步调整镜面角度
       ├── 扫描对准 (sweep alignment): 扫描寻找最佳抑制点
       └── 脉冲回旋管法: 利用 ECE 反馈信号精确定位沉积

    PCS 层面的进展（非 ECRH 范围，仅供参考）:
    • 多 NTM 模式同时控制 — PCS 负责策略决策和执行器分配
    • "捕获-制服"(catch-and-subdue)策略 — PCS 负责触发/关闭 ECCD
    • 非线性优化求解执行器分配 — PCS 的集成控制功能

    ═══════════════════════════════════════════════════════════
```

### 3.3 ITER 的计划

```
    ITER ECRH 射线追踪的计算挑战
    ═══════════════════════════════════════════════════════════

    ECRH 系统规模:
    • 24 条 ECCD 束线 (170 GHz, 总功率 20 MW)
    • 沉积精度要求: Δρ < 0.02（约 5-7 mm）
    • 上端口 Launcher 用于离轴 ECCD
    
    射线追踪计算方案:
    • 基于 ASDEX Upgrade 的 rt-TORBEAM 方案移植
    • 24 束同时追踪 → 计算量比 ASDEX 12 束翻倍
    • 等离子体剖面输入的数据链延迟增加
    
    ECRH 射线追踪面临的挑战:
    • 24 束 × 15-20 ms = 仍然只能做正向计算
    • 无法实时优化 Launcher 角度（等离子体更大，剖面变化更复杂）
    • 计算延迟可能不满足 PCS 要求的响应速度
    • 当前 CPU 方案的可扩展性不足
    
    ★ ITER 的 ECRH 射线追踪需求正在推动业界寻找更快的计算方案
    ═══════════════════════════════════════════════════════════
```

### 3.4 新兴方法：物理简化 + 反向射线追踪 (2025)

2025年初发表的一种新方法（发表于 *Plasma Physics and Controlled Fusion*）提出了一种 **反向射线追踪** 思路：

```
    传统正向射线追踪 vs 反向射线追踪
    ═══════════════════════════════════════════════════════════

    传统（正向）: 
    "从 Launcher 出发 → 射线在等离子体中传播 → 看沉积在哪里"
    
    问题: 不知道结果会沉积在哪，需要扫描大量初始角度才能找到
          对准目标磁面的角度 → 搜索空间是 4 维 (R, f, θ_tor, θ_pol)
          需要百万次射线追踪 → 只能离线做
    
    ─────────────────────────────────────────────────────────
    
    新方法（反向）:
    "给定目标磁面 → 反向重构最优射线路径 → 得到需要的 Launcher 角度"
    
    优势: 直接从目标出发，不需要盲目搜索
          只需几百次计算 → 比正向方法快 ~10000 倍
          已在两种托克马克等离子体剖面上验证
    
    局限: 需要简化的物理模型，精度不如完整 TORBEAM
          仅解决离线优化问题，未用于实时控制
    ═══════════════════════════════════════════════════════════
```

### 3.5 业界 ECRH 射线追踪现状总结

| 维度 | 当前水平 | 面临的天花板 |
|------|---------|-------------|
| **实时射线追踪速度** | 15-20 ms / 12束（ASDEX/DIII-D rt-TORBEAM） | CPU 单核性能极限 |
| **能否实时优化 Launcher 角度** | **不能** —— ECRH 只能计算当前角度的沉积位置 | 搜索最优角度需要 100-1000 倍更多计算 |
| **使用的硬件** | 多核 CPU（通过多线程并行化各束） | 束间并行已用尽，单束内部无法再并行 |
| **替代加速手段** | 查找表插值 / 简化物理模型 / 反向追踪 | 精度牺牲，适应性差 |
| **AI/ML 辅助** | ML 重建剖面作为射线追踪输入（DIII-D RTCAKENN, < 8ms） | 仅辅助数据输入，射线追踪本身未 AI 化 |
| **GPU 加速** | 等离子体射线追踪 GPU 实现**已有研究原型**，尚无 ECRH 实时部署 | ★ 这正是未开发的机会 |

---

## 4. ECRH 系统内的计算瓶颈分析

### 4.1 BEST ECRH 射线追踪的性能需求

| 参数 | BEST ECRH 需求 | ASDEX Upgrade ECRH 现状 | 差距 |
|------|----------|-------------------|------|
| 束线数量 | 12（上端口 8 条用于离轴 ECCD） | 12 | 相当 |
| **ECRH 射线追踪目标周期** | **< 1 ms** | 15-20 ms | **差 15-20 倍** |
| 角度优化 | **需要实时搜索最优角度** | 仅正向计算沉积位置 | **质的差距** |
| 沉积精度 | Δρ < 0.05 (~2 cm) | 类似 | 相当 |
| 等离子体尺寸 | BEST > ASDEX | -- | 射线路径更长，积分步更多 |

### 4.2 ECRH 内部时间预算分解

```
    ECRH 系统内部响应时间分解（从接收 PCS 指令到 Launcher 执行）
    ═══════════════════════════════════════════════════════════

    ECRH 系统分配到的时间预算: < 3 ms
    （PCS 从检测到输出 ρ_target 约 2 ms，不在 ECRH 管辖范围内）
    
    ┌───────────────────────┬─────────────┬──────────────────┐
    │ ECRH 内部环节          │ 估计耗时     │ 能否压缩          │
    ├───────────────────────┼─────────────┼──────────────────┤
    │ 接收 PCS 数据          │ ~0.1 ms     │ 反射内存网        │
    │ ★ 射线追踪计算        │ ★ 15-20 ms  │ ★ ECRH 的瓶颈    │
    │ 角度指令下发           │ ~0.1 ms     │ EtherCAT          │
    │ Launcher 机械响应     │ ~1 ms       │ 机械限制          │
    ├───────────────────────┼─────────────┼──────────────────┤
    │ ECRH 内部总计          │ ~16-21 ms   │ 远超 3 ms 预算    │
    └───────────────────────┴─────────────┴──────────────────┘
    
    ★ 射线追踪占 ECRH 内部延迟的 >90%
    ★ 即使通信和机械响应均为零，射线追踪本身也远超预算
    ★ 如果还要搜索最优角度（100个候选），则 15ms × 100 = 1.5 秒
      ← 完全不可能在 ECRH 控制周期内完成
    
    ═══════════════════════════════════════════════════════════
```

### 4.3 当前 ECRH 射线追踪的妥协方案及其代价

| 妥协方案 | ECRH 系统的做法 | 代价 |
|---------|------|------|
| **预计算查找表** | 离线计算大量 (等离子体参数, Launcher角度) → 沉积位置 的映射表，运行时查表插值 | 等离子体参数变化时精度下降；需为每种运行场景预计算；存储和管理成本高 |
| **简化物理模型** | 用冷等离子体近似或几何光学近似替代完整相对论色散关系 | 高温高密度下精度不足 |
| **仅正向计算** | 只计算"当前角度沉积在哪"，不搜索"哪个角度最优" | 不能自动适应等离子体变化，ECCD 沉积效率次优 |
| **扫描对准** | 机械地缓慢扫描 Launcher 角度，用实验信号找最佳点 | 速度慢（秒级），响应不及时 |

**ECRH 系统的核心困境**：CPU 的计算能力在射线追踪这个环节已经到顶。多线程只能并行不同束（束间并行），但 **单束内部的射线积分是串行的**。增加 CPU 核数无法突破单条射线的计算速度。这意味着 ECRH 系统无法在 PCS 给出 ρ_target 后快速求解最优 Launcher 角度。

---

## 5. GPU 加速射线追踪：为什么是天然匹配

### 5.1 关键洞察：两种并行性

射线追踪问题中存在 **两个层次的并行性**，CPU 方案只利用了一层：

```
    射线追踪的两层并行性
    ═══════════════════════════════════════════════════════════

    并行层次 1: 束间并行 —— 不同束线的射线追踪完全独立
    ────────────────────────────────────────────────────────
    
    束线 1 的射线: ●──→──→──→──→──→ 沉积位置 ρ₁
    束线 2 的射线: ●──→──→──→──→──→ 沉积位置 ρ₂
    束线 3 的射线: ●──→──→──→──→──→ 沉积位置 ρ₃
    ...
    束线 12 的射线: ●──→──→──→──→──→ 沉积位置 ρ₁₂
    
    ★ CPU 方案已利用此并行性（多线程，每线程一束）
    ★ 并行度 = 12 → 用 12 个 CPU 核即可
    
    ────────────────────────────────────────────────────────
    并行层次 2: 角度搜索并行 —— 不同候选角度的射线追踪完全独立
    ────────────────────────────────────────────────────────
    
    同一束线，候选角度 θ₁: ●──→──→──→ 沉积在 ρ_dep(θ₁)
    同一束线，候选角度 θ₂: ●──→──→──→ 沉积在 ρ_dep(θ₂)
    同一束线，候选角度 θ₃: ●──→──→──→ 沉积在 ρ_dep(θ₃)
    ...
    同一束线，候选角度 θ₁₀₀₀: ●──→──→──→ 沉积在 ρ_dep(θ₁₀₀₀)
    
    ★ CPU 方案 **未利用** 此并行性（顺序逐个计算不同角度）
    ★ 并行度 = 1000+ → 需要 1000+ 并行执行单元
    ★ 这正是 GPU 的优势所在！
    
    ════════════════════════════════════════════════════════
    
    组合后总并行度: 12 束 × 1000 角度 = 12000 路完全独立计算
    → 完美匹配 GPU 的大规模并行架构
```

### 5.2 等离子体射线追踪 vs 图形学光线追踪

| 对比项 | 计算机图形学 Ray Tracing | 等离子体 Ray Tracing |
|--------|------------------------|---------------------|
| 介质 | 分段均匀（空气/材质表面） | 连续非均匀（等离子体密度/磁场梯度） |
| 传播方程 | 直线 + 表面反射/折射 | Hamilton ODE 连续积分（折射连续发生） |
| 每条射线计算量 | 主要在交点计算 | 主要在 ODE 积分（~10⁴ 步） |
| 独立性 | 每条射线完全独立 ✓ | 每条射线完全独立 ✓ |
| GPU 适合性 | 已被证明极其适合 GPU | **同样适合** —— 大量独立射线 × 计算密集 |

**核心论点**：等离子体射线追踪的并行结构与图形学光线追踪 **在本质上完全相同** —— 都是大量独立射线的并行计算。不同之处仅在于单条射线的内部计算内容。GPU 在图形学中已经证明了自己处理此类问题的能力，同样的硬件架构可以直接用于等离子体射线追踪。

### 5.3 为什么 CPU 方案已经到顶

```
    CPU vs GPU 架构对比（射线追踪视角）
    ═══════════════════════════════════════════════════════════

    CPU (如 AMD EPYC 9654, 96 核):
    ┌──────────────────────────────────────────────────────┐
    │  核1  核2  核3  ...  核96                            │
    │  ┌─┐  ┌─┐  ┌─┐      ┌──┐                           │
    │  │█│  │█│  │█│      │█ │   每个核很强（高主频）     │
    │  │█│  │█│  │█│      │█ │   但只有 96 个核          │
    │  │█│  │█│  │█│      │█ │                            │
    │  └─┘  └─┘  └─┘      └──┘                           │
    │                                                      │
    │  可并行: 96 条射线 → 12束 × 8角度                     │
    │  搜索 1000 角度: 需要 ~125 轮串行迭代                  │
    │  时间: 125 × 0.15ms = ~19 ms                         │
    └──────────────────────────────────────────────────────┘

    GPU (如 AMD Instinct MI250X, 14080 流处理器):
    ┌──────────────────────────────────────────────────────┐
    │  ┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐   │
    │  ││││││││││││││││││││││││││││││││││││││││││││       │
    │  └┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘   │
    │  ... × 14080 个流处理器                              │
    │                                                      │
    │  每个流处理器较弱（低主频）                            │
    │  但有 14080 个！                                      │
    │                                                      │
    │  可并行: 12束 × 1000角度 = 12000 → 一轮全部完成       │
    │  时间: ~0.15ms × 1 轮 = ~0.15 ms                     │
    │  (实际含开销 ~0.3-0.5 ms)                             │
    └──────────────────────────────────────────────────────┘

    加速比: CPU 19 ms → GPU 0.5 ms ≈ 40-100 倍
    更关键: GPU 能做 CPU 根本做不到的事（实时全局角度优化）
```

---

## 6. AMD GPU 实施方案详细设计

### 6.1 硬件选型

| 候选硬件 | 计算性能 (FP64) | 显存 | 特点 | 推荐 |
|---------|----------------|------|------|:----:|
| AMD Instinct MI250X | 47.9 TFLOPS | 128 GB HBM2e | 双芯封装，最高 FP64 性能 | ★ 首选 |
| AMD Instinct MI300A | 61.3 TFLOPS | 128 GB 统一内存（CPU+GPU） | APU 架构，CPU-GPU 零拷贝 | 备选（更新一代） |
| AMD Instinct MI300X | 81.7 TFLOPS | 192 GB HBM3 | 最高性能 GPU | 如预算允许 |

> **为什么需要 FP64**：等离子体射线追踪中的 ODE 积分对数值精度敏感，特别是在折射剧烈的区域。FP32 可能导致射线位置累积误差过大。AMD Instinct 系列的 FP64 性能远优于消费级 GPU。

### 6.2 软件架构

```
    GPU 加速射线追踪软件栈
    ═══════════════════════════════════════════════════════════

    ┌─────────────────────────────────────────────────────┐
    │                 ECRH-MC 主控制逻辑                   │
    │                 (C++ / Python)                       │
    │                                                     │
    │  接收 PCS 数据 → 调用 GPU 模块 → 下发角度指令        │
    └───────────────────────┬─────────────────────────────┘
                            │ API 调用
    ┌───────────────────────┴─────────────────────────────┐
    │            GPU 射线追踪服务 (libECRT-GPU)             │
    │                                                      │
    │  ┌──────────────────────────────────────────────┐    │
    │  │ 接口层 (Host, C++)                            │    │
    │  │  • 接收等离子体参数 (ne, Te, B 剖面)          │    │
    │  │  • 生成候选角度网格                            │    │
    │  │  • 管理 GPU 内存和内核调度                     │    │
    │  │  • 收集结果，执行最优化搜索                    │    │
    │  └────────────────────┬─────────────────────────┘    │
    │                       │ PCIe / Infinity Fabric        │
    │  ┌────────────────────┴─────────────────────────┐    │
    │  │ GPU 内核层 (Device, HIP/ROCm)                 │    │
    │  │                                               │    │
    │  │  Kernel 1: ray_trace_kernel                   │    │
    │  │    每个线程追踪一条射线 (一个角度一个束线)      │    │
    │  │    内部循环: ODE 积分 ~10⁴ 步                 │    │
    │  │    输出: 沉积位置 ρ_dep, 沉积宽度, ECCD 效率   │    │
    │  │                                               │    │
    │  │  Kernel 2: dispersion_eval                    │    │
    │  │    色散关系评估（共享内存优化）                 │    │
    │  │                                               │    │
    │  │  Kernel 3: absorption_calc                    │    │
    │  │    相对论吸收系数计算                          │    │
    │  │                                               │    │
    │  │  Kernel 4: optimize_search                    │    │
    │  │    并行归约，找到最优角度                      │    │
    │  │    min |ρ_dep(θ,φ) - ρ_target|               │    │
    │  │    同时约束 ECCD 效率最大化                    │    │
    │  └───────────────────────────────────────────────┘    │
    │                                                      │
    │  编程模型: AMD ROCm / HIP (可移植到 CUDA)            │
    │  数学库: rocBLAS, rocSOLVER (线性代数加速)           │
    │  优化: 共享内存缓存等离子体剖面数据                   │
    │        Warp 级归约求最优解                             │
    │        异步流水线：当前周期计算 与 下周期数据传输重叠   │
    └──────────────────────────────────────────────────────┘
```

### 6.3 关键优化策略

| 优化 | 技术手段 | 效果 |
|------|---------|------|
| **等离子体剖面缓存** | 将 ne(R,Z), Te(R,Z), B(R,Z) 加载到 GPU 共享内存/纹理内存 | 避免每条射线每步都从全局内存读取，带宽提升 10x+ |
| **ODE 积分器选择** | 使用 RK4（4阶 Runge-Kutta），固定步长 + 自适应步长混合 | 计算量可预测，适合 GPU SIMT 执行模型 |
| **角度网格自适应** | 第一轮粗网格（100 点）→ 找到近似最优区域 → 第二轮细网格（100 点）在该区域细化 | 用 200 次计算达到 10000 次均匀搜索的精度 |
| **异步流水线** | 当 GPU 计算本周期射线时，CPU 同时准备下一周期的等离子体数据 | 隐藏数据传输延迟 |
| **多束批处理** | 12 束 × N 角度 打包为一个大 kernel launch | 减少 kernel 启动开销 |

### 6.4 与 ECRH 控制系统的集成

```
    GPU 射线追踪与 ECRH-MC 的集成方式
    ═══════════════════════════════════════════════════════════

    ┌─────────────────────────────────────────────────────────┐
    │                    ECRH-MC 服务器                        │
    │                                                         │
    │  ┌─────────────┐     ┌──────────────────────────────┐  │
    │  │ 控制主循环   │     │ AMD Instinct MI250X          │  │
    │  │ (CPU)       │     │ (PCIe 插卡)                   │  │
    │  │             │     │                               │  │
    │  │  t=0:       │     │                               │  │
    │  │  接收 PCS   │────→│  GPU 射线追踪 (~0.3 ms)       │  │
    │  │  数据       │     │  1000 角度全搜索               │  │
    │  │             │←────│  返回最优 (θ_opt, φ_opt)      │  │
    │  │  t=0.5ms:   │     │                               │  │
    │  │  下发角度   │     │                               │  │
    │  │  指令       │     │                               │  │
    │  │             │     │                               │  │
    │  │  (周期 < 1ms)│     │                               │  │
    │  └─────────────┘     └──────────────────────────────┘  │
    │                                                         │
    │  备份方案: GPU 故障时自动切换到 CPU 查找表模式            │
    │           （降级运行，精度下降但不影响安全）              │
    └─────────────────────────────────────────────────────────┘

    安装位置: 控制室机房 (低磁场、低辐射、温控环境)
    散热: 服务器标准风冷/液冷
    功耗: ~500W (服务器总功耗)
```

### 6.5 降级和容错

| 场景 | 应对 |
|------|------|
| GPU 硬件故障 | 自动切换到 CPU 预计算查找表模式（与当前业界做法相同） |
| GPU 计算超时 | 使用上一周期结果 + 线性外推 |
| 等离子体参数输入异常 | 保持上一有效角度不变，报警 |
| GPU 驱动崩溃 | 看门狗检测，自动重启 GPU 服务；过渡期用查找表 |

**核心原则**：GPU 是性能增强层。GPU 完全失效时，系统退化到当前业界标准水平（查找表），不影响基本的 NTM 控制能力和系统安全。

---

## 7. 预期性能与对比

### 7.1 ECRH 射线追踪性能估算

| 指标 | 当前业界最好 (rt-TORBEAM on CPU) | BEST ECRH 方案 (GPU) | 提升倍数 |
|------|-------------------------------|-----------------|---------|
| 单束正向射线追踪 | ~1.5 ms (优化后) | **~0.01 ms** | **~150x** |
| 12 束并行正向追踪 | ~15-20 ms (多线程) | **~0.02 ms** (GPU 全并行) | **~750x** |
| 全局角度优化 (1000 候选) | **不可能实时** (~15 秒) | **< 0.5 ms** | **从不可能到实时** |
| ECRH 内部响应延迟 | ~16-21 ms | **< 1.5 ms** | **~10-14x** |

### 7.2 ECRH 系统能力的质变

```
    GPU 为 ECRH 射线追踪带来的能力升级
    ═══════════════════════════════════════════════════════════

    以前 ECRH 做不到 → GPU 后能做到:
    ─────────────────────────────────────────────────

    ✗ → ✓  实时全局角度优化
           ECRH 不再依赖预计算查找表
           每个控制周期针对 PCS 给出的 ρ_target 实时求解最优 (θ,φ)

    ✗ → ✓  等离子体参数变化的自适应
           等离子体密度/温度变化时，ECRH 射线路径自动重新计算
           不再使用可能过时的离线查找表

    ✗ → ✓  多目标联合优化
           ECRH 在求解 (θ,φ) 时可同时优化:
           沉积位置对准精度 + ECCD 驱动效率 + 功率利用率
           这是一个多维约束优化问题，只有大量并行搜索才能实时求解

    ✗ → ✓  多束线沉积方案实时求解
           PCS 给出多个 ρ_target 时（如同时抑制 3/2 和 2/1），
           ECRH 可实时计算 12 束线对多个目标的最优角度分配
           （注: 哪些束线分配给哪个目标的策略由 PCS 决定，
            ECRH 负责在给定分配下求解各束的最优角度）

    ✗ → ✓  输入不确定性下的鲁棒角度选择
           ECRH 同时计算"最优角度"和"对 ne/Te 输入不确定性的敏感度"
           选择对输入误差最不敏感的鲁棒角度

    ═══════════════════════════════════════════════════════════
```

### 7.3 对 BEST 整体运行的间接影响

> 以下影响是 ECRH 射线追踪加速后，通过 PCS 整体控制链条体现出的 **系统级效果**。ECRH 系统贡献的是更快、更精确的执行器响应，最终物理效果的实现取决于 PCS + ECRH + 诊断的协同。

| 间接影响 | 说明 | ECRH 的贡献 |
|---------|------|------------|
| 更高的 βN 运行空间 | ECCD 沉积更精确 → PCS 可在更高 β 下维持稳定 | ECRH 提供亚毫秒级角度响应 |
| 更低的 ECCD 功率消耗 | 精确沉积 → 更高的驱动效率 → 节省功率 | ECRH 通过全局角度优化保证最佳沉积 |
| 更强的破裂避免支持 | PCS 要求的快速角度切换可被 ECRH 及时执行 | ECRH 内部延迟 < 1.5 ms 而非 ~20 ms |

---

## 8. 总结与展望

### 8.1 核心结论

| 结论 | 说明 |
|------|------|
| **ECRH 射线追踪是系统内部最大的计算瓶颈** | 接收 PCS 的 ρ_target 后，求解最优 (θ,φ) 的延迟占 ECRH 内部响应的 >90% |
| **当前 CPU 方案只能做正向计算，无法实时优化角度** | 业界最好水平 15-20 ms，搜索最优角度需 100-1000 倍更多计算量 |
| **GPU 是突破此瓶颈的最自然硬件** | 射线追踪的大规模并行性（束间 × 角度搜索）天然匹配 GPU 架构 |
| **AMD Instinct GPU 可将射线追踪延迟从 15ms 压缩到 < 0.5ms** | 使 ECRH 系统首次具备实时全局角度优化能力 |
| **这是 ECRH 执行器能力的质变** | 从"被动接受角度查表"到"实时精确求解最优角度"，显著提升 ECCD 沉积精度和效率 |

> **再次强调系统边界**：NTM 检测/定位/策略决策由 PCS 和诊断系统负责。ECRH 通过 GPU 加速射线追踪解决的是**自身作为执行器的响应速度和精度问题**。更快更精确的 ECRH 响应，间接支撑了 PCS 的 NTM 抑制策略效果。

### 8.2 与业界发展趋势的关系

```
    ECRH 射线追踪技术在聚变领域的发展阶段
    ═══════════════════════════════════════════════════════════

    阶段 1 (已完成):                     阶段 2 (进行中):
    CPU 离线射线追踪                      CPU 实时射线追踪
    • TORBEAM / GRAY / GENRAY            • rt-TORBEAM (ASDEX/DIII-D)
    • 秒→分钟级计算                       • 15-20 ms 级计算
    • 用于 ECRH 设计和离线分析            • ECRH 正向沉积位置计算
                                          • 无法实时优化角度

    阶段 3 (本方案所处位置):              阶段 4 (未来):
    GPU 加速实时射线追踪 ←── BEST ECRH    AI+GPU 融合
    • 亚毫秒级计算                        • 神经网络代理射线追踪模型
    • ECRH 实时全局角度优化               • ECRH 自学习最优角度策略
    • 自适应等离子体参数变化               • 与 PCS 更紧密的协同优化
    ★ 业界首个 ECRH 实时部署的 GPU 射线追踪

    ═══════════════════════════════════════════════════════════

    BEST ECRH 方案定位: 领先业界一个阶段，从阶段 2 跨越到阶段 3
    通过 AMD Instinct GPU 实现这一跨越
```

### 8.3 开发路线建议

| 阶段 | 时间 | 工作内容 |
|------|------|---------|
| **Phase 0: 算法验证** | 6 个月 | 将 TORBEAM/GRAY 核心射线追踪算法移植到 HIP/ROCm；在 AMD GPU 上验证正确性和性能 |
| **Phase 1: 角度优化框架** | 6 个月 | 开发 GPU 并行角度搜索框架 (ρ_target → θ_opt, φ_opt)；用公开等离子体剖面数据验证 |
| **Phase 2: ECRH-MC 集成** | 6 个月 | 与 ECRH-MC 控制系统集成；实现 < 1 ms ECRH 内部射线追踪延迟；开发 CPU 查找表降级方案 |
| **Phase 3: 装置验证** | BEST 运行后 | 在 BEST 实际放电中验证 ECRH GPU 射线追踪的精度和实时性；与 PCS 联调 |

---

## 参考文献

1. E. Poli et al., "TORBEAM, a beam tracing code for electron-cyclotron waves in tokamak plasmas," *Computer Physics Communications*, 2001.
2. E. Poli et al., "Real-time beam tracing for control of the deposition location of electron cyclotron waves," *Fusion Engineering and Design*, 2015. — 首次将 TORBEAM 加速 100 倍用于 ASDEX Upgrade 实时控制。
3. A.S. Welander et al., "Development of robust and multi-mode control of tearing in DIII-D," — DIII-D 多模式 NTM 控制最新进展。
4. "Parallelized Real-time Physics Codes for Plasma Control on DIII-D," arXiv:2511.11964, 2025. — DIII-D 实时物理代码并行化。
5. R. Shousha et al., "Machine learning-based real-time kinetic profile reconstruction in DIII-D," — ML 辅助实时剖面重建 (< 8ms)。
6. "Performance-Portable GPU Acceleration of the EFIT Tokamak Plasma Equilibrium Reconstruction Code," OSTI, 2024. — EFIT GPU 加速，支持 AMD MI250X。
7. "Fast physics-based launcher optimization for electron cyclotron current drive," *Plasma Phys. Control. Fusion*, 2025. — 反向射线追踪优化方法。
8. D. Farina, "A Quasi-Optical Beam-Tracing Code for Electron Cyclotron Absorption and Current Drive: GRAY," *Fusion Science and Technology*, 2007.
9. N.B. Marushchenko et al., "Ray-tracing code TRAVIS for ECR heating, EC current drive and ECE diagnostic," — W7-X 使用的射线追踪代码。
10. S. Sautner et al., "A GPU based 3D raytracing algorithm for DUED laser fusion code," *Plasma Phys. Control. Fusion*, 2024. — GPU 射线追踪在聚变中的应用实例。

---

*本文档分析了 ECRH 系统中射线追踪——即"将 PCS 给定的 ρ_target 翻译为最优 Launcher 角度 (θ, φ)"——这一核心计算任务的瓶颈与加速方案。NTM 检测、定位和策略决策属于 PCS 和诊断系统的职责，ECRH 系统作为执行器，需要解决的计算问题是在亚毫秒级时间内完成射线追踪和角度优化。基于对 ASDEX Upgrade、DIII-D 和 ITER 方案的调研，当前业界最佳 CPU 方案的射线追踪周期为 15-20ms，无法实现实时角度优化。AMD Instinct GPU 凭借其大规模并行计算能力，可将 ECRH 内部射线追踪延迟压缩至 <0.5ms，并首次使实时全局角度优化成为可能——显著提升 ECRH 系统作为 ECCD 执行器的响应速度和沉积精度。*
